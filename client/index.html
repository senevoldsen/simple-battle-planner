<!DOCTYPE html>
<html>
<head>
    <title>Quick Start - Leaflet</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="css/leaflet.css" />
    <script src="js/EventEmitter.js"></script>
    <script src="js/map.js"></script>
    <script src="js/gui.js"></script>
    <script src="js/net.js"></script>
    <script src="lib/leaflet-src.js"></script>
    <!-- <script src="lib/L.TileLayer.NoGap.js"></script> -->
    <script src="lib/milsymbol.js"></script>
</head>
<body>

<input type="button" onclick="doReset()" value="Reset" />
<!-- <div id="mapid" style="width: 600px; height: 400px;"></div> -->
<!-- <hr/> -->
<div id="bp_map" style="margin-left: auto; margin-right: auto; width: 80%; height: 1000px;"></div>

<script type="text/javascript">

 // Per object transmission based on delta to key-indexed objects. Possible JSON struct keyed by /room/object_id
 // Fix coordinate conversions

    var mapConfigs = {};
    mapConfigs.taunus = {
        title: "XCAM Taunus",
        tilePrefix: "maps/taunus/",
        lowerLeftPixel: [1*512+250, 37*512+154],
        lowerLeftPos: [0, 0],
        upperRightPixel: [38*512+100, 0*512+294],
        upperRightPos: [20480, 20480],
        pixelSize: [40*512, 38*512],
        maxZoom: 0,
        minZoom: -6,
        tileSize: 512
    };

    const G = {};

    G.bpMap = new BP.Map(mapConfigs.taunus);

    // Construct Leaflet items

    const mapCenter = new L.latLng(G.bpMap.gameToMap([G.bpMap.constants.gameWidth / 2, G.bpMap.constants.gameHeight / 2]));
    const mapBounds = L.latLngBounds([
        new L.latLng(G.bpMap.gameToMap(G.bpMap.constants.lowerLeftPos)),
        new L.latLng(G.bpMap.gameToMap(G.bpMap.constants.upperRightPos))
    ]);

    G.leafMap = L.map('bp_map', {
        crs: L.CRS.Simple,
        minZoom: G.bpMap.info.minZoom,
        maxZoom: G.bpMap.info.maxZoom,
        zoom: -3
    });

    G.leafMap.setView(mapCenter, G.bpMap.info.minZoom + 5);

    const tileSize = G.bpMap.info.tileSize || 256;
    const tileLayer = L.tileLayer(G.bpMap.info.tilePrefix + 'z{z}/image_{x}_{y}.jpg', {
        minZoom: G.bpMap.info.minZoom,
        maxZoom: G.bpMap.info.maxZoom,
        maxNativeZoom: G.bpMap.info.maxZoom,
        continuousWorld: true,
        bounds: mapBounds,
        tileSize: tileSize
    }).addTo(G.leafMap);

    G.markerLayer = L.layerGroup().addTo(G.leafMap);
    const popup = L.popup().setContent('<p>Hello world!<br />This is a nice popup.</p>');

    // Wire state events together
    G.events = new EventEmitter();

    G.events.on('gui.unit.created', (unit) => {
        G.events.trigger('object.updated', [{oid: unit.oid, object: unit}]);
        G.netContext.send({type: 'key-set', key: unit.oid, value: unit});
    });

    G.events.on('gui.unit.deleted', (unit) => {
        G.events.trigger('object.updated', [{oid: unit.oid, object: null}]);
        G.netContext.send({type: 'key-delete', key: unit.oid});
    });

    G.events.on('gui.unit.updated', (unit) => {
        G.events.trigger('object.update-remote', [unit]);
    });

    G.events.on('object.update-remote', (object) => {
        G.netContext.send({type: 'key-set', key: object.oid, value: object});
    });

    G.events.on('state.received', (remoteState) => {
        BP.gui.processState(remoteState);
    });

    G.events.on('state.send', (state) => {
        G.netContext.send({
            type: 'state',
            value: state
        });
    });

    G.events.on('object.updated', (data) => {
        BP.gui.processObject(data.oid, data.object);
    });



    function onLeftClickOnMap(e) {
        const pos = e.latlng;
        if (mapBounds.contains(pos)) {
            const gamePos = G.bpMap.mapToGame([pos.lat, pos.lng]);
            const unit = BP.gui.getRandomUnitDescription();
            unit.pos = gamePos;
            G.events.trigger('gui.unit.created', [unit]);    
        }
    }

    function onContextMenu() {
        popup.setLatLng(e.latlng).openOn(G.leafMap);
    }

    G.leafMap.on('click', onLeftClickOnMap);

    G.leafMap.on('contextmenu',function(e){
    });

    function doReset() {
        var newState = {};
        G.events.trigger('state.send', [newState]);
        // Fake the it being received to update state
        G.events.trigger('state.received', [newState]);
    }

    var hostname = window.location.hostname || "localhost";
    var socketAddress = "ws://" + hostname + ":8020/";
    G.netContext = BP.net.connect(socketAddress);
    
    G.netContext.on('error', (errorMsg) => {
        var message = errorMsg.message || errorMsg.code;
    });


    G.netContext.on('state', (state) => {
        G.events.trigger('state.received', [state]);
    });

    G.netContext.on('key-set', (data) => {
        const key = data.key;
        const value = data.value;
        G.events.trigger('object.updated', [{oid: key, object: value}]);
    });

    G.netContext.on('key-delete', (data) => {
        const key = data.key;
        G.events.trigger('object.updated', [{oid: key, object: null}]);
    });

</script>

</body>
</html>
